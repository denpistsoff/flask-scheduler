<!-- manage.html -->
{% extends 'base.html' %}

{% block title %}Управление данными{% endblock %}

{% block content %}
{% if not current_user.is_authenticated %}
<script>
    window.location.href = "{{ url_for('login') }}";
</script>
{% endif %}

<div class="manage-container">
    <h1><i class="fas fa-cog"></i> Управление данными</h1>

    <div class="tabs">
        <button class="tab-btn active" onclick="showTab('teachers')">
            <i class="fas fa-chalkboard-teacher"></i> Преподаватели
        </button>
        <button class="tab-btn" onclick="showTab('groups')">
            <i class="fas fa-users"></i> Группы
        </button>
        <button class="tab-btn" onclick="showTab('rooms')">
            <i class="fas fa-building"></i> Аудитории
        </button>
        <button class="tab-btn" onclick="showTab('courses')">
            <i class="fas fa-book"></i> Курсы
        </button>
    </div>

    <div id="teachers-tab" class="tab-content active">
        <h3>Управление преподавателями</h3>
        <div class="data-table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ФИО</th>
                        <th>Макс часов/день</th>
                        <th>Предпочитаемые дни</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody id="teachers-table"></tbody>
            </table>
        </div>
    </div>

    <div id="groups-tab" class="tab-content">
        <h3>Управление группами</h3>
        <div class="data-table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Название</th>
                        <th>Кол-во студентов</th>
                        <th>Макс часов/день</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody id="groups-table"></tbody>
            </table>
        </div>
    </div>

    <div id="rooms-tab" class="tab-content">
        <h3>Управление аудиториями</h3>
        <div class="data-table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Название</th>
                        <th>Вместимость</th>
                        <th>Тип</th>
                        <th>Расписание</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody id="rooms-table"></tbody>
            </table>
        </div>
    </div>

    <div id="courses-tab" class="tab-content">
        <h3>Управление курсами</h3>
        <div class="data-table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Название</th>
                        <th>Тип</th>
                        <th>Часов/нед</th>
                        <th>Преподаватель</th>
                        <th>Группа</th>
                        <th>Тип аудитории</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody id="courses-table"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
let currentTab = 'teachers';

function showTab(tabName) {
    currentTab = tabName;

    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.onclick.toString().includes(tabName));
    });

    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.toggle('active', content.id === `${tabName}-tab`);
    });

    loadTabData(tabName);
}

async function loadTabData(tab) {
    switch(tab) {
        case 'teachers':
            await loadTeachers();
            break;
        case 'groups':
            await loadGroups();
            break;
        case 'rooms':
            await loadRooms();
            break;
        case 'courses':
            await loadCourses();
            break;
    }
}

function getDaysDisplay(daysString) {
    if (!daysString) return '-';

    const daysMap = {
        '1': 'Пн',
        '2': 'Вт',
        '3': 'Ср',
        '4': 'Чт',
        '5': 'Пт'
    };

    const days = daysString.split(',').map(d => daysMap[d] || d);
    return days.map(day => `<span class="days-badge-small">${day}</span>`).join(' ');
}

function getRoomTypeName(type) {
    const types = {
        'lecture_hall': 'Лекционная',
        'computer_class': 'Компьютерный класс',
    };
    return types[type] || type;
}

function getCourseTypeName(type) {
    const types = {
        'lecture': 'Лекция',
        'practice': 'Практика',
    };
    return types[type] || type;
}

async function loadTeachers() {
    try {
        const teachers = await fetch('/api/teachers').then(r => r.json());
        const table = document.getElementById('teachers-table');
        table.innerHTML = teachers.map(t => `
            <tr>
                <td>${t.id}</td>
                <td><strong>${t.name}</strong></td>
                <td>${t.max_hours}</td>
                <td>${getDaysDisplay(t.preferred_days)}</td>
                <td>
                    <button onclick="editTeacher(${t.id})" class="btn btn-sm btn-info">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteTeacher(${t.id})" class="btn btn-sm btn-danger">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    } catch (error) {
        console.error('Error loading teachers:', error);
    }
}

async function loadGroups() {
    try {
        const groups = await fetch('/api/groups').then(r => r.json());
        const table = document.getElementById('groups-table');
        table.innerHTML = groups.map(g => `
            <tr>
                <td>${g.id}</td>
                <td><strong>${g.name}</strong></td>
                <td>${g.size}</td>
                <td>${g.max_hours}</td>
                <td>
                    <button onclick="editGroup(${g.id})" class="btn btn-sm btn-info">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteGroup(${g.id})" class="btn btn-sm btn-danger">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    } catch (error) {
        console.error('Error loading groups:', error);
    }
}

async function loadRooms() {
    try {
        const rooms = await fetch('/api/rooms').then(r => r.json());
        const table = document.getElementById('rooms-table');
        table.innerHTML = rooms.map(r => `
            <tr>
                <td>${r.id}</td>
                <td><strong>${r.name}</strong></td>
                <td>${r.capacity}</td>
                <td>${getRoomTypeName(r.type)}</td>
                <td>
                    <button onclick="editRoomSchedule(${r.id})" class="btn btn-sm btn-warning">
                        <i class="fas fa-calendar-alt"></i> Расписание
                    </button>
                </td>
                <td>
                    <button onclick="editRoom(${r.id})" class="btn btn-sm btn-info">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteRoom(${r.id})" class="btn btn-sm btn-danger">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    } catch (error) {
        console.error('Error loading rooms:', error);
    }
}

async function loadCourses() {
    try {
        const courses = await fetch('/api/courses').then(r => r.json());
        const table = document.getElementById('courses-table');
        table.innerHTML = courses.map(c => `
            <tr>
                <td>${c.id}</td>
                <td><strong>${c.name}</strong></td>
                <td>${getCourseTypeName(c.type)}</td>
                <td>${c.hours}</td>
                <td>${c.teacher_name || '-'}</td>
                <td>${c.group_name || '-'}</td>
                <td>${getRoomTypeName(c.room_type)}</td>
                <td>
                    <button onclick="editCourse(${c.id})" class="btn btn-sm btn-info">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteCourse(${c.id})" class="btn btn-sm btn-danger">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    } catch (error) {
        console.error('Error loading courses:', error);
    }
}

// Функции редактирования (заглушки)
function editTeacher(id) {
    alert('Редактирование преподавателя - в разработке');
}

function editGroup(id) {
    alert('Редактирование группы - в разработке');
}

function editRoom(id) {
    alert('Редактирование аудитории - в разработке');
}

function editRoomSchedule(id) {
    alert('Редактирование расписания аудитории - в разработке');
}

function editCourse(id) {
    alert('Редактирование курса - в разработке');
}

// Функции удаления
async function deleteTeacher(id) {
    if (confirm('Удалить преподавателя?')) {
        try {
            await fetch(`/api/teachers/${id}`, {method: 'DELETE'});
            loadTeachers();
        } catch (error) {
            console.error('Error deleting teacher:', error);
        }
    }
}

async function deleteGroup(id) {
    if (confirm('Удалить группу?')) {
        try {
            await fetch(`/api/groups/${id}`, {method: 'DELETE'});
            loadGroups();
        } catch (error) {
            console.error('Error deleting group:', error);
        }
    }
}

async function deleteRoom(id) {
    if (confirm('Удалить аудиторию?')) {
        try {
            await fetch(`/api/rooms/${id}`, {method: 'DELETE'});
            loadRooms();
        } catch (error) {
            console.error('Error deleting room:', error);
        }
    }
}

async function deleteCourse(id) {
    if (confirm('Удалить курс?')) {
        try {
            await fetch(`/api/courses/${id}`, {method: 'DELETE'});
            loadCourses();
        } catch (error) {
            console.error('Error deleting course:', error);
        }
    }
}

// Инициализация
showTab('teachers');
</script>
{% endblock %}